<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
		"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>

	<title>_WidgetBase lifecycle unit test</title>

	<script type="text/javascript" src="../boilerplate.js"></script>
	<script type="text/javascript">
		require([
			"doh/runner",
			"dojo/aspect", "dojo/dom",
			"dui/register", "dui/registry", "dui/_WidgetBase",
			"dojo/domReady!"
		], function(doh, aspect, dom, register, registry, _WidgetBase){

			var obj = {
				foo: function(){
					// summary: empty function that we connect to
				}
			};

			// Number of times foo was called while TestWidget existed
			var calls = 0;

			TestWidget = register("test-widget", [HTMLElement, _WidgetBase], {
				postCreate: function(){
					// Rather odd call to this.own() for testing the connections are dropped on destroy()
					this.own(aspect.after(obj, "foo", function(){
						calls++;
					}, true));
				}
			});

			var w;

			doh.register("create and destroy", [
				{
					name: "upgrade plain DOMNode",
					runTest: function(t){
						w = document.getElementById("w1");
						register.upgrade(w);

						doh.t(registry.byId("w1"), "widget in registry");

						// test the connection
						doh.is(0, calls, "foo() not called yet");
						obj.foo();
						doh.is(1, calls, "foo() called");
					}
				},
				{
					name: "destroy",
					runTest: function(t){
						w.destroy();

						doh.f(registry.byId("w1"), "widget no longer in registry");

						// test the connection was destroyed
						calls = 0;
						obj.foo();
						doh.is(0, calls, "connection was deleted");

						// test the DOM node was removed
						doh.f(dom.byId("w1"), "DOM Node removed");
					}
				},
				{
					name: "destroy(true)  (preserving DOM node)",
					runTest: function(t){
						w = document.getElementById("w2");
						register.upgrade(w);

						doh.t(registry.byId("w2"), "widget in registry");
						w.destroy(true);

						doh.f(registry.byId("w2"), "widget no longer in registry");

						// test the DOM node *wasn't* removed
						doh.t(dom.byId("w2"), "DOM Node left");
					}
				},
				{
					name: "create with undefined id",
					runTest: function(t){
						// If id is "specified" as undefined, generate a new one
						w = new TestWidget({id: undefined});

						doh.isNot(undefined, w.id)
					}
				}
			]);

			doh.register("setter not called on creation", function(){
				// Setters are no longer called on creation except for parameters sent to new Foo(...)
				var fooSetterCalled = false;
				var MyWidget = register("my-widget", [HTMLElement, _WidgetBase], {
					foo: 345,
					_setFooAttr: function(val){
						fooSetterCalled = val;
						this._set("foo", val);
					}
				});

				new MyWidget();

				doh.is(false, fooSetterCalled, "fooSetterCalled");
			});

			doh.register("tweaking params in postMixInProperties", function(){
				// Tests that property changes in postMixInProperties() are not lost (#16080)
				var Test = register("lifecycle-test", [HTMLElement, _WidgetBase], {
					foo: "bar",
					postMixInProperties: function(){ this.foo = "baz"; }
				});
				var t = new Test({ foo: "blah" });
				doh.is("baz", t.foo);
			});

			doh.run();
		});

	</script>
</head>
<body class="claro">
	<test-widget id="w1"></test-widget>
	<test-widget id="w2"></test-widget>
</body>
</html>
