<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>_WidgetBase on() test</title>
	<script type="text/javascript" src="../boilerplate.js"></script>
	<script>
		require([
			"doh/runner",
			"dojo/has", "dojo/_base/lang", "dojo/on", "dojo/touch",
			"dui/register", "dui/registry", "dui/_WidgetBase", "dojo/domReady!"
		], function(doh, has, lang, on, touch, register, registry, _WidgetBase){

			var mousedOver, clicked;

			doh.register("on", [
				function setup(){
					MyWidget = register("my-widget", [HTMLElement, _WidgetBase], {
						postCreate: function(){
							on(this, "click", lang.hitch(this, "onFooBar"));
						},
						onFooBar: function(){
							// This is called whenever the widget is clicked
						},
						foobar: function(){
							// A widget.on("foobar") should go to onFooBar() (above), not here
						}
					});

					register.parse();
				},

				function connect(){
					// This should work despite the fact that the function onMouseOver has
					// multiple capital letters
					registry.byId("myWidget").on("mouseover", function(){
						mousedOver = true;
						console.log("mouseover event");
					});

					// Likewise, this should work despite the fact that the function onFooBar has
					// multiple capital letters
					registry.byId("myWidget").on("foobar", function(){
						clicked = true;
						console.log("click event");
					});
				},

				function test(){
					var myWidget = registry.byId("myWidget");

					// Test that _WidgetBase.on() catches click event
					doh.f(clicked, "clicked");
					on.emit(myWidget, "click", {
						bubbles: true,
						cancelable: true,
						which: 1
					});
					doh.t(clicked, "clicked");

					// Test that _WidgetBase.on() catches mouseover event
					doh.f(mousedOver, "mousedOver");
					on.emit(myWidget, "mouseover", {
						bubbles: true,
						cancelable: true,
						which: 1
					});
					doh.t(mousedOver, "mousedOver");
				},

				function synthetic(){
					// Test that on() works for synthetic events

					var myWidget = registry.byId("myWidget"),
						touched;

					myWidget.on(touch.press, function(){
						touched = true;
					});

					on.emit(myWidget, navigator.msPointerEnabled ? "MSPointerDown" : has("touch") ? "touchstart" : "mousedown", {
						bubbles: true,
						cancelable: true,
						which: 1
					});

					doh.t(touched, "touched");
				},

				function syntheticNoCallbackArgs(){
					var evt = null;
					var MyWidget = register("my-widget2", [HTMLElement, _WidgetBase], {
						show: function(){
							return this.emit('show');
						},
						onshow: function(e){
							evt = e;
						}
					});
					new MyWidget({}).show();
					doh.isNot(null, evt, "onshow was called with event object");
				}
			]);

			doh.run();
		});

	</script>
</head>
<body class="claro">
	<my-widget id="myWidget">
		mouseover and click events to console
	</my-widget>
</body>
</html>
