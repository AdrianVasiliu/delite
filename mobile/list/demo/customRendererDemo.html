<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<title>Custom renderer for list items</title>

	<link rel="stylesheet" type="text/css" href="../../../../dui/mobile/list/css/List.css">
	<script type="text/javascript" src="../../deviceTheme.js"></script>
	<script type="text/javascript" src="../../../../dojo/dojo.js"
		data-dojo-config="packages: [{name: 'dojox', location:'../dui'}, {name: 'dijit', location:'../dui'}], async: true, parseOnLoad: true"></script>

	<script type="text/javascript">
		require([
			"dojo/_base/declare",
			"dojo/dom-class",
			"dui/registry",
			"dojo/store/Memory",
		    "dui/_TemplatedMixin",
		    "dui/mobile/list/renderer/AbstractEntryRenderer",
		    "dui/mobile/list/renderer/AbstractCategoryRenderer",
			"dui/mobile/list/renderer/List",
			"dojo/parser"
		], function(declare, domClass, registry, MemoryStore, _TemplatedMixin, AbstractEntryRenderer, AbstractCategoryRenderer, List){

 			// the model that contains the list entries from the catalog
			var catalogStoreModel = [];
			for (var i = 1; i < 208; i++){
				catalogStoreModel.push({season: Math.floor(i / 13) + 1, img: 'http://g-ecx.images-amazon.com/images/G/02/uk-dvd/images/warner/hbo-logo-small._SS50_V198464807_.jpg', title: 'The Sopraninos episode ' + i, description: 'Tonino is really really depressed, at least for the ' + i + 'st time...'});
			};
			var catalogModel = new MemoryStore({data: catalogStoreModel});
			
			// Custom renderer for the catalog entries
			var catalogController = {
				cart: {}, // the cart in which user push catalog entries to buy
				detailed: {} // store information about catalog entries that are selected to display details
			};
			
			var CatalogEntryRenderer = declare([AbstractEntryRenderer, _TemplatedMixin], {
			
				catalogController: catalogController,
				
				templateString: '<li><div class="entryContainer" data-dojo-attach-event="onclick: toggleDetail"><div class="entryHeader"><img class="entryIcon" data-dojo-attach-point="image"><span class="entryTitle" data-dojo-attach-point="title" tabindex=-1></span></div><div data-dojo-attach-point="entryDetail" class="entryDetails hidden"><span class="entryDescription" data-dojo-attach-point="description" tabindex=-1></span><a class="" href="javascript:;" data-dojo-attach-point="addToCartLink" data-dojo-attach-event="onclick: addToCart" tabindex=-1>Add to Cart</a></div></div></li>',

				startup: function(){
					this.inherited(arguments);
					this._setFocusableNodes(["title", "description", "addToCartLink"]);
				},

				focusNextElement: function(next){
					var returnedId = this.inherited(arguments);
					if(!this.catalogController.detailed[this.entryIndex]){
						this.toggleDetail();
					}
					return returnedId;
				},

				onBlur: function(){
					if(this.catalogController.detailed[this.entryIndex]){
						this.toggleDetail();
					}
				},

				buildRendering: function(){
					this.inherited(arguments);
					this.title.id = this.id + 'title';
					this.description.id = this.id + 'description';
					this.addToCartLink.id = this.id + 'addToCartLink';
				},

				renderEntry: function(value){
					var img = value ? (value.img ? value.img : '') : '';
					var title = value ? (value.title ? value.title : '') : '';
					var description = value ? (value.description ? value.description : '') : '';
					this.image.setAttribute('src', img);
					this.title.innerHTML = title;
					this.description.innerHTML = description;
					this._updateDetailRendering();
					this._updateAddToCartLinkRendering();
					// notify the list that we have externaly updated its rendering, so that it
					// performs internal sizing calculations if it needs to.
					registry.byId('list').renderingUpdated();
				},

				toggleDetail: function(event){
					if(this.catalogController.detailed[this.entryIndex]){
						delete this.catalogController.detailed[this.entryIndex];
					}else{
						this.catalogController.detailed[this.entryIndex] = true;
					}
					this._updateDetailRendering();
				},
		
				addToCart: function(event){
					event.stopPropagation();
					alert('Item ' + JSON.stringify(catalogStoreModel[this.entryIndex]) + ' has been added to your cart.');
					// TODO: RESTORE FOCUS TO THE PREVIOUS CELL ELEMENT THAT WAS HAVING THE FOCUS...
					this.catalogController.cart[this.entryIndex] = true;
					this._updateAddToCartLinkRendering();
				},
		
				_updateDetailRendering: function(){
					if(this.catalogController.detailed[this.entryIndex]){
						domClass.remove(this.entryDetail, 'hidden');
					}else{
						domClass.add(this.entryDetail, 'hidden');
					}
					// notify the list that we have externaly updated its rendering, so that it
					// performs internal sizing calculations if it needs to.
					registry.byId('list').renderingUpdated();
				},
		
				_updateAddToCartLinkRendering: function(){
					if(this.catalogController.cart[this.entryIndex]){
						domClass.add(this.addToCartLink, 'hidden');
					}else{
						domClass.remove(this.addToCartLink, 'hidden');
					}
				}
			});
			
			// Custom renderer for the categories
			var CatalogCategoryRenderer = declare([AbstractCategoryRenderer], {
				renderCategory: function(value){
					this.domNode.innerHTML = 'SEASON ' + value;
				}
			});
			 // create a list widget for the catalog, using the custom entries renderer
			var list = new List({id: 'list',
				                 height: 600,
				                 entries: {store: catalogModel},
				                 pageLength: 50,
				                 entriesRenderer: CatalogEntryRenderer,
				                 categoriesRenderer: CatalogCategoryRenderer,
				                 categoryAttribute: 'season'}, 'list3');
			// startup the list
			list.startup();
		});
	</script>

	<style type="text/css">

		/* Catalog list entries */
		
 		.entryContainer{
			padding: 8px 8px 8px 8px;
		}

		.entryHeader{
			cursor: pointer;
		}

		.entryTitle{
			font-weight: bold;
			font-size: large;
			position: relative;
			padding-left: 10px;
			top: -18px;
		}

		.entryLabel{
			font-size: large;
			padding-left: 15px;
		}

		.entryDetails{
		}

		.entryDescription{
			font-style: italic;
		}

		.hidden{
			display: none;
		}

	</style>
</head>
<body style="visibility:hidden;">
	<div data-dojo-type="dui/mobile/View">
		<div data-dojo-type="dui/mobile/Heading" data-dojo-props="label: 'Sopraninos Episodes'"></div>
		<p>Click on an episode to see details and reveal add to cart button.</p>
		TODO: ACTION ON CUSTOM CATEGORY RENDERER (TO DISPLAY A SUMMARY OF THE SEASON, FOR EXAMPLE)<br>
		TODO: CUSTOM PAGE LOADER RENDERER<br>
		TODO: KEYBOARD NAVIGATION: SHOULD A RENDERER BE NOTIFIED THAT THE CELL HAS THE FOCUS ? IMPLEMENT AN EXAMPLE THAT REACT TO THE CELL BEING FOCUSED<br>
		<div id="list3"></div>
	</div>
</body>
</html>
